[[{"l":"Welcome"}],[{"l":"Personas","p":["alt text"]}],[{"i":"#","p":["Setup a new namespace for onboarding services on the BC Gov API Gateway."]},{"l":"API Provider User Journey","p":["The following steps walk an API Owner through setting up an API on the BC Gov API Gateway in our Test instance. If you are ready to deploy to our Production instance, use the links found at the bottom of this document ( here)."]},{"l":"1. Register a new namespace","p":["A namespace represents a collection of Kong Gateway Services and Routes that are managed independently.","To create a new namespace, login to the API Services Portal.","After login, click the namespace dropdown in the top right next to your user name (it may show No Active Namespace), then click Create New Namespace.","The namespace must be an alphanumeric string between 5 and 15 characters (RegExp reference: ^[a-z][a-z0-9-]{4,14}$).","You can select and manage namespaces by clicking the namespace dropdown in the top right next to your user name."]},{"l":"2. Generate a Service Account","p":["Access.Manage","Content.Publish","CredentialIssuer.Admin","GatewayConfig.Publish","Go to the Namespaces tab, click the Service Accounts link, and click the New Service Account and select the GatewayConfig.Publish permissions for the Service Account and click Share. A new credential will be created - make a note of the ID and Secret.","Namespace.Manage","Namespace.View","Permission","Permission to approve/reject access requests to your APIs that you make discoverable","Permission to create Authorization Profiles so that they are available to be used when configuring Product Environments","Permission to publish gateway configuration to Kong and to view the status of the upstreams","Permission to update the Access Control List for controlling access to viewing metrics, service configuration and service account management (effectively a superuser for the namespace)","Permission to update the documentation on the portal","Read-only access to the namespace","Scope","The available Scopes are:"]},{"l":"3. Prepare configuration","p":["The gateway configuration can be hand-crafted or you can use a command line interface that we developed called gwa to convert your Openapi v3 spec to a Kong configuration."]},{"i":"31-hand-crafted-recommended-if-you-dont-have-an-openapi-spec","l":"3.1. Hand-crafted (recommended if you don't have an Openapi spec)","p":["Simple Example","To view common plugin config go to Common Controls","To view some other plugin examples go here.","Declarative Config Behind the scenes, DecK is used to sync your configuration with Kong. For reference: https://docs.konghq.com/deck/overview/","Splitting Your Config: A namespace tag with the format ns.$NS is mandatory for each service/route/plugin. But if you have separate pipelines for your environments (i.e./ dev, test and prod), you can split your configuration and update the tags with the qualifier. So for example, you can use a tag ns.$NS.dev to sync Kong configuration for dev Service and Routes only.","Upstream Services on OCP4: If your service is running on OCP4, you should specify the Kubernetes Service in the Service.host. It must have the format: name.ocp-namespace.svc. Also make sure your Service.port matches your Kubernetes Service Port. Any Security Policies for egress from the Gateway will be setup automatically on the API Gateway side. The Aporeto Network Security Policies are being removed in favor of the Kubernetes Security Policies (KSP). You will need to create a KSP on your side looking something like this to allow the Gateway's test and prod environments to route traffic to your API:","Migrating from OCP3 to OCP4? Please review the OCP4-Migration instructions to help with transitioning to OCP4 and the new APS Gateway.","Require mTLS between the Gateway and your Upstream Service? To support mTLS on your Upstream Service, you will need to provide client certificate details and if you want to verify the upstream endpoint then the ca_certificates and tls_verify is required as well. An example:","NOTE: You must generate a UUID ( python -c 'import uuid; print(uuid.uuid4())') for each certificate and ca_certificate you create (set the id) and reference it in your services details.","HELPER: Python command to get a PEM file on one line: python -c 'import sys; import json; print(json.dumps(open(sys.argv[1]).read()))' my.pem"]},{"i":"32-gwa-command-line","l":"3.2. gwa Command Line","p":["Run: gwa new and follow the prompts.","Example:","See below for the gwa CLI install instructions."]},{"l":"4. Apply gateway configuration","p":["The Swagger console for the gwa-api can be used to publish Kong Gateway configuration, or the gwa Command Line can be used."]},{"i":"41-gwa-command-line-recommended","l":"4.1. gwa Command Line (recommended)","p":["Install (for Linux)","Using MacOS or Windows? Download here: https://github.com/bcgov/gwa-cli/releases/tag/v1.3.1","NOTE: As of version 1.2+ there is support for v2 of our api. To continue using v1 of the api, ensure that the API Version is set to 1 (see below)","Configure","Create a .env file and update the CLIENT_ID and CLIENT_SECRET with the new credentials that were generated in step #2:","NOTE: The -T indicates our Test environment. For production use -P.","Publish","If you want to see the expected changes but not actually apply them, you can run:"]},{"i":"42-swagger-console","l":"4.2. Swagger Console","p":["Go to gwa-api Swagger Console.","Select the PUT/namespaces/{namespace}/gateway API.","The Service Account uses the OAuth2 Client Credentials Grant Flow. Click the lock link on the right and enter in the Service Account credentials that were generated in step #2.","For the Parameter namespace, enter the namespace that you created in step #1.","Select dryRun to true.","Select a configFile file.","Send the request."]},{"i":"43-postman","l":"4.3. Postman","p":["From the Postman App, click the Import button and go to the Link tab.","Enter a URL: https://openapi-to-postman-api-gov-bc-ca.test.api.gov.bc.ca/?u=https://gwa-api-gov-bc-ca.test.api.gov.bc.ca/docs/v2/openapi.yaml","After creation, go to Collections and right-click on the Gateway Administration (GWA) API collection and select edit.","Go to the Authorization tab, enter in your Client ID and Client Secret and click Get New Access Token.","You should get a successful dialog to proceed. Click Proceed and Use Token.","You can then verify that the token works by going to the Collection Return key information about authenticated identity and click Send."]},{"l":"5. Verify routes","p":["To verify that the Gateway can access the upstream services, run the command: gwa status.","In our test environment, the hosts that you defined in the routes get altered; to see the actual hosts, log into the API Services Portal, go to the Namespaces tab, go to Gateway Services and select your particular service to get the routing details.","To help with troubleshooting, you can use the GWA API to get a health check for each of the upstream services to verify the Gateway is connecting OK.","Go to the GWA API, enter in the new credentials that were generated in step #2, click Try it out, enter your namespace and click Execute. The results are returned in a JSON object."]},{"l":"6. View metrics","p":["The following metrics can be viewed in real-time for the Services that you configure on the Gateway:","Request Rate: Requests / Second (by Service/Route, by HTTP Status)","Latency: Standard deviations measured for latency inside Kong and on the Upstream Service (by Service/Route)","Bandwidth: Ingress/egress bandwidth (by Service/Route)","Total Requests: In 5 minute windows (by Consumer, by User Agent, by Service, by HTTP Status)","All metrics can be viewed by an arbitrary time window - defaults to Last 24 Hours.","Go to Grafana to view metrics for your configured services.","You can also access summarized metrics from the API Services Portal by going to the Namespaces tab and clicking the Gateway Services link."]},{"l":"7. Grant access to others","p":["To grant access to others, you need to grant them the appropriate Scopes. This can be done from the API Services Portal, selecting the relevant Namespace and going to the Namespaces Namespace Access page. From here, you are able to grant Users access to the Namespace."]},{"i":"8-add-to-your-cicd-pipeline","l":"8. Add to your CI/CD Pipeline","p":["Update your CI/CD pipelines to run the gwa-cli to keep your services updated on the gateway."]},{"i":"81-github-actions-example","l":"8.1. Github Actions Example","p":["In the repository that you maintain your CI/CD Pipeline configuration, use the Service Account details from Step 2 to set up two Secrets:","GWA_ACCT_ID","GWA_ACCT_SECRET","Add a .gwa folder (can be called anything) that will be used to hold your gateway configuration.","An example Github Workflow:"]},{"l":"9. Share your API for Discovery","p":["Base URI : https://api-gov-bc-ca.test.api.gov.bc.ca/ds/api","Can use y2j to convert from YAML to JSON","chmod +x /usr/local/bin/y2j","echo -e #'!'/usr/bin/env python\\nimport sys,yaml,json\\nprint(json.dumps(yaml.safe_load(open(sys.argv[1]).read()))) /usr/local/bin/y2j","Edit Profile default","Enter the client_id and client_secret for your Service Account.","For contents(documentation), the service account must have the Content.Publish scope","For datasets and products, the service account must have the Namespace.Manage scope","For issuers, the service account must have the CredentialIssuer.Admin scope","NOTE: The steps below use restish, but we will be working on upgrading the gwa command line interface to support these APIs","Package your APIs and make them available for discovery through the API Services Portal and BC Data Catalog.","restish my_api list or restish my_api get-new-id product","Restish Setup","scopes: openid","Select Finished with profile and then Save and exit","Select Setup Auth> oauth-client-credentials","The API Services Portal Directory organizes your APIs by Products and Environments. You can manage them via an API or through the UI.","The below example works with the service created above, so we will want to reference the NS environment variable.","To use the Directory API, the following scopes are required:","To verify that restish is working, run:","token_url: Provided to you when you created the Service Account","V1: V1 Directory API Console","V2: V2 Directory API Console","View the Directory API:"]},{"i":"91-setup-authorization-profiles","l":"9.1 Setup Authorization Profiles","p":["If your APIS are protected with one of the OAuth2 grant types, then an Authorization profile must be created with the appropriate credentials for accessing the corresponding Identity Provider/Broker and Authorization Server."]},{"i":"92-setup-your-product-environments-and-link-your-services","l":"9.2 Setup your Product, Environments and link your Services"},{"i":"93-update-gateway-configuration-based-on-flow","l":"9.3 Update Gateway Configuration based on Flow","p":["In the previous section our example defines an environment that is protected using Kong's API Key and ACL plugins. To activate an environment, the corresponding plugins need to exist on the Gateway for that service or routes. The ACL allow corresponds to the unique Environment ID defined in section 9.2."]},{"i":"94-publish-environments","l":"9.4 Publish Environments","p":["Your products will not appear on the Directory until you mark the relevant environments as Active. You can do this by either updating the Product Environment configuration above to active: true, or going to the API Services Portal UI and editing the Environment details."]},{"i":"95-publish-documentation","l":"9.5 Publish Documentation"},{"i":"96-view-your-product-in-the-api-directory","l":"9.6 View your product in the API Directory","p":["Find your API in the API Services Portal Directory","It is now ready to receive access requests from the community!"]},{"l":"Production Links","p":["API Services Portal","gwa-api Swagger Console","gwa-api Postman Collection","Gateway Metrics - Grafana"]}],[{"i":"#","p":["Configuration the Gateway with an Identity Provider and Client Credential Grant"]},{"l":"Protecting an API with OAuth2 Client Credential Flow","p":["Steps for protecting and calling an API using the OAuth2 Client Credential Grant.","Configuring an API on the Kong Gateway","Granting Access to the IdP","Client Requesting Access","Provider Approving Access","Client Retrieving the Access Token","Client Calling an API","Gateway Proxying to Upstream","alt text"]},{"l":"1. Configuring an API on the Kong Gateway","p":["The API Provider User Journey document provides the steps to enable a new API on the Kong Gateway. It will walk you through the creation of a new Namespace, and a Service Account that can be used to configure the Kong Gateway and the Authorization Profile described in step 2.","Once the API is working on the Gateway, you can then define a Product, which can be made available on the API Services Portal Directory."]},{"l":"2. Granting Access to the IdP"},{"i":"a-prerequisites","l":"a) Prerequisites","p":["Before the Portal can be configured, a new set of credentials must be created on the IdP. For this tutorial, we will include the steps when Keycloak is the IdP.","Create a new Client on the IdP","Create a new client with Access Type confidential. All flows except Service Accounts should be turned off.","Make a note of the Client ID and Client Secret, they will be used when the Portal Authorization Profile is created.","The Full Scope Allowed can be turned off and the realm-management client roles for manage-clients and manage-users should be added.","Add the manage-clients and manage-users client roles to the Service Account Roles."]},{"i":"b-setup-the-authorization-profile","l":"b) Setup the Authorization Profile","p":["A credential with CredentialIssuer.Admin is required to update Authorization Profiles ( CredentialIssuer).","Authorization Profiles can be setup either via the Portal or by using a Service Account with the Portal Directory API.","Update the below CredentialIssuer to include the environment details and the Scopes and Roles setup for authorization."]},{"i":"c-link-the-authorization-profile-to-the-product","l":"c) Link the Authorization Profile to the Product","p":["Before making the API available on the Directory, the API should be configured with a plugin for protecting access. To do this, an API Provider can edit the Product details to select Oauth2 Client Credential Flow and the newly created Authorization Profile."]},{"i":"d-update-your-gateway-configuration-with-the-plugin","l":"d) Update your Gateway Configuration with the Plugin","p":["Update your Gateway Configuration to include the jwt-keycloak plugin.","HINT: When you configure the Product Environment, a Plugin Template will be displayed - this can be a starting point for protecting your API on the Gateway.","Finally, from the Portal, enable the Environment to make it available on the API Directory."]},{"i":"e-optional-configuration","l":"e) Optional Configuration","p":["Client Mappers","Edit the Authenticated Access Policies -> Allowed Protocol Mapper Types to include the oidc-audience-mapper.","If you have Client Scopes that you want to have controlled by the Portal, add them to the Realm's Client Scopes and Default Client Scopes on the IdP.","If you have Roles that you want to have controlled by the Portal, add them to the Client's Roles.","If you want to use the Authorization services, then set Authorization Enabled to ON for the Client on the IdP. You will also want to set the Decision Strategy to Affirmative.","In Keycloak, this is updated under the Realm's Client Registration-> Client Registration Policies.","resourceAccessScope- The API Services Portal has not completed the implementation for the scenario where the User is the Resource Owner ( resourceAccessScope is left blank). It uses the Token Exchange capability but it's an optional service available on Keycloak and has numerous caveats around it. Please contact the APS team if interested to know more.","resourceAccessScope: Used in the case where the Resource Server owns all the resources, a user must have the resourceAccessScope assigned in order to be allowed to manage the access. If it is not set, then the user has to be the resource owner in order to manage access.","resourceScopes: A list of the Authorization Scopes managed for the particular Resources (required)","resourceType: The Resource Type of the resources that will be managed (required)","Roles","Scopes","The audience is an optional mapper that can be added to a Client.","The IdP needs to have a policy that allows Audience to be added as a Protocol Mapper to the client.","UMA2 Authorization Resources","Update the CredentialIssuer record above to match the availableScopes with the ones added on the IdP.","Update the CredentialIssuer record above to match the clientRoles with the ones added on the IdP.","Update the following CredentialIssuer attributes:"]},{"l":"3. Client Requesting Access","p":["Request access to the API via the API Services Portal and generate the credentials to be used below.","The Portal will use the credentials setup in the Authorization Profile, to create a disabled Client on the IdP (with any applicable Client Mappers) and return the credentials to the Requesting user."]},{"l":"4. Provider Approving Access","p":["An Access Manager reviews the access request, sets any additional controls, grants the relevant permissions (i.e./ scopes and roles), and approves. The Portal will enable the Client and apply the permissions on the IdP.","The Portal sends a notification to the Requester letting them know that API Access has been approved (or rejected)."]},{"l":"5. Client Retrieving the Access Token","p":["Using the Credentials generated in step 3, the Requester calls the Token endpoint to get a new JWT token."]},{"l":"6. Client Calling the API","p":["Extract the Access Token from the response, set it in a TOK environment variable, and call the API.","The API Gateway's jwt-keycloak plugin will use the IdP's public keys to validate the token and depending on the plugin configuration, validate the scopes or roles."]},{"l":"7. Gateway Proxying to Upstream","p":["A technical, but important step in the integration is the Gateway proxying the request to the Upstream Service API and deciding on the different options for securing that interaction.","Options:","Network Policy: If the Services are co-located on the same Cluster as the Gateway's Data Plane, then native network policies can be used to protect the channel between the Gateway and the Upstream Service. This approach is used for Services running on the Openshift Silver cluster.","Kong Upstream JWT: This plugin adds a signed JWT to the request headers so that the Upstream Service can verify that the request came specifically from the Gateway.","Client Certificates: Client certificates (mTLS) provides a way for the Upstream Service to provide a secure channel from the Gateway and to verify that the request came specifically from the Gateway.","Firewall IP Restrictions: This provides a low-level of protection by limiting the IPs to the ones of the Gateway Data Planes. Because the Data Planes are typically on shared infrastructure, this would still allow traffic from other tenants. This might be acceptable based on the type of data delivered by or to the Upstream Service."]},{"l":"Variations"},{"l":"Signed JWT","p":["The Authorization Profile clientAuthenticator was set to client-secret in this tutorial, but there is an alternate setup that can be used:","client-jwt-jwks-url(Signed JWT with JWKS URL)","In this scenario, when a Client is requesting access, they will be required to enter a public URL that holds the public key information for a key pair that will be used in step 5 when retrieving the Bearer Token. For further details, you can see the specific example Variation - Signed JWT."]}],[{"i":"#","p":["Accessing an API with Signed JWT and Client Credential Grant"]},{"l":"Signed JWT Authentication","p":["The following example uses NodeJS code to show how to prepare for signed JWT authentication to an API on the BC Government API Gateway."]},{"l":"1. Generate a Certificate Key Pair"},{"l":"2. Publish the Public Key","p":["Publish the Public Key in JWKS Format at a location that is publically accessible.","Place the JWKS JSON file somewhere that it can be reached publically.","For testing, an easy option is to use Github Pages and publish the JWKS JSON file in order to make a public URL. For example:"]},{"l":"3. Request Access to an API","p":["Go to the API Services Portal ( https://api-gov-bc-ca.test.api.gov.bc.ca/) and request access to an API that is configured with the Signed JWT protection. After requesting access, you will be provided with some secrets.","Make a note of the Client ID, Issuer and Token Endpoint."]},{"l":"4. Request a Client JWT Token","p":["Requesting a Client JWT Token is a two-step process:","Build a Client Assertion Token that is signed with the private key you generated earlier.","Request a token from the Token Endpoint using the Client Assertion.","The following sample performs both steps:"]},{"l":"5. Call the API","p":["Call the API using the newly generated Token returned from the Identity Provider."]}],[{"l":"Supported Plugins","p":["Current list of plugins available on the API Gateway.","NOTE: The httplog is not available for individual teams to use as it is used at a global level to feed logs to other systems for audit/monitoring/etc.","If there are other plugins that you would like to have added to the Gateway, please reach out to us at our Rocket.Chat channel #aps-ops."]}],[{"l":"Common Controls","p":["The following are sample Gateway controls for common scenarios."]},{"l":"Returning an HTTP Redirect"},{"l":"Adding Headers For Best Security Practices","p":["For further information on individual headers, see: https://owasp.org/www-project-secure-headers/"]},{"l":"Rate Limit"},{"i":"option-1---using-a-distributed-cache","l":"Option 1 - Using a Distributed Cache","p":["This provides the most accurate because it uses a centralized Cache that all Kong nodes use. The downside is that there is a 100-200ms latency."]},{"i":"option-2---node-local-caching","l":"Option 2 - Node Local Caching","p":["This provides the fastest rate limiting option, with minimal latency (~ 1ms). The downside is that it is local to each node so calculating the actual load on your upstream is a function of the number of nodes."]},{"l":"Two-tiered access setup","p":["The key-auth and jwt-keycloak plugins support the concept of allowing \"anonymous\" access, which allows you to define a \"free\" service which might have limits around it (like only allowing 100 requests/minute), and then an \"elevated\" access where the Consumer would get an improved level of service, such as higher rate limits.","There is a global \"anonymous\" consumer that is identified as \"ce26955a-cf08-4907-9427-12d01c8bd94c\" in both our Test and Production environments.","To enable anonymous access to your API, update your plugin configuration with:"]},{"l":"key-auth"},{"l":"jwt-keycloak"}],[{"l":"Access Control List","p":["Reference: https://docs.konghq.com/hub/kong-inc/acl/"]},{"l":"Use Cases","p":["Typically this is used when your Environment configuration uses the flow kong-api-key-acl or kong-acl-only where the allow group is a special group defined for the Environment so that Access Managers can grant/revoke access to the Service from the API Services Portal."]},{"l":"Example"}],[{"l":"GWA IP Anonymity"},{"l":"Use Cases","p":["A user's IP address is considered part of PII (Personally Identifiable Information). This is a custom plugin that was created to mask the last segment of the IP address before it is sent to the Upstream Service."]},{"l":"Example"}],[{"l":"JWT Keycloak"},{"l":"Example"}],[{"l":"Key Auth","p":["Reference: https://docs.konghq.com/hub/kong-inc/key-auth/"]},{"l":"Example"}],[{"l":"Kong Upstream JWT","p":["Reference: https://docs.konghq.com/hub/optum/kong-upstream-jwt"]},{"l":"Example"}],[{"l":"OIDC"},{"l":"Example"}],[{"l":"OIDC Consumer","p":["Description: This plugin is used in conjunction with the oidc plugin to map the JWT Token to a Kong Consumer."]},{"l":"Example"}],[{"l":"Request Transformer","p":["Reference: https://docs.konghq.com/hub/kong-inc/request-transformer/"]},{"i":"example","l":"Example:"}],[{"l":"SSL Termination","p":["If you would like to verify the SSL endpoint for *.api.gov.bc.ca, you can run the following two commands and compare the fingerprint and serial no."]},{"i":"apigovbcca","l":"*.api.gov.bc.ca","p":["1B588948FBB2","20:7D:15:9D:42:BE:CC:BC:FD:EF:DF:13:77:C7:25:A3:A4:72:45:05","3B5849D8A670","4D:EA:CE:C4:0A:73:67:D3:B4:03:F6:63:C4:E1:67:2C:47:9D:EA:82","7876EB597E14","Deployed","E3:DF:EC:89:BC:03:9B:E9:7D:57:91:EB:52:18:59:46:AA:A9:3A:15","Expires","Feb 16 2021","Feb 25 2021","Issue Date","Oct 16 2021","Oct 16 2022","Oct 6 2020","Oct 6 2021","Sep 27 2021","Serial No.","SHA1 Fingerprint","You can run the above as one line:"]},{"l":"Internal Notes","p":["Individual File Verification","Cert/Key Verification"]}],[{"l":"1. Login","p":["API Owner Login"]}],[{"l":"2. Create Service Account","p":["Create Service Account"]}],[{"l":"3. Switch Namespace","p":["Switch Namespace"]}],[{"i":"4-requestapprove-access","l":"4. Request/Approve Access"},{"l":"Request Access"},{"l":"Approve Access"}],[{"l":"5. Consumer Maintenance"},{"l":"Maintain Consumer Roles"},{"l":"Maintain Consumer Scopes"}],[{"l":"Web Sequence Diagrams"},{"l":"API Owner Login"},{"l":"Switch Namespace"},{"l":"Create Service Account"},{"l":"Request Access"},{"l":"Approve Access"},{"l":"Maintain Consumer Scopes and Roles"}],[{"i":"#","p":["API Services Portal Released - JUN 2021"]},{"i":"api-services-portal-beta-is-live","l":"API Services Portal BETA is Live!","p":["We are happy to announce that the API Services Portal has been released into Production.","A few notable points:","The following applications have reached end-of-life and are now demised:","ARGG: If you would like to publish an API, please follow the steps in the API Owner User Journey.","KQ: Requesting access to APIs is now done via the Directory page on the API Services Portal.","API Keys: API Keys provides a way for developers to generate API Keys for access to BC Gov APIs in non-production environments. This is now done via the Directory page on the API Services Portal.","There will be a period of time where API Keys will remain available as we transition clients over to the new API Services Portal - link to old API Keys","If you have questions or require assistance, please visit our RocketChat Channel aps-ops."]},{"l":"Links","p":["API Owner User Journey"]}],[{"i":"#","p":["API Services Portal Released - MAY 2022"]},{"i":"api-services-portal-release-11","l":"API Services Portal Release 1.1","p":["Activity at Organization and Namespace level","All API Services Documentation is now available at: https://bcgov.github.io/aps-infra-platform","API Directory Request Access","Applications","Cascade deletion of namespace and/or environment:","Delete Environment and Namespace with \"force\" verification","Directory API V1 end of life Aug 31, 2022","Directory API V2 released:","Get Gateway Services configuration","Get Namespace Dataset, Product, Content, Issuer details","Improved validation for Environment activation:","Log activity for deleted namespace","My Access","My Profile","Namespace Authorization Profiles","Namespace must be assigned to an Organization","New/Enhanced Features","Organization access management (including membership, and namespace assignment)","Organization Group access displayed on the Namespace Access page","Product's Dataset must belong to the same organization","Revoking of all related consumer access","Revoking Service Accounts","UX Upgrades","Verify no Gateway Services still exist"]}]]