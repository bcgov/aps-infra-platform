<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="turbo-root" content="/aps-infra-platform">
    <meta name="turbo-cache-control" content="no-cache" data-turbo-track="reload" data-track-token="3.5.0.750538702969">

    <!-- See retype.com -->
    <meta name="generator" content="Retype 3.5.0">

    <!-- Primary Meta Tags -->
    <title>Client Credential Protection</title>
    <meta name="title" content="Client Credential Protection">
    <meta name="description" content="Configuration the Gateway with an Identity Provider and Client Credential Grant">

    <!-- Canonical -->
    <link rel="canonical" href="https://bcgov.github.io/aps-infra-platform/guides/tutorial-idp-client-cred-flow/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://bcgov.github.io/aps-infra-platform/guides/tutorial-idp-client-cred-flow/">
    <meta property="og:title" content="Client Credential Protection">
    <meta property="og:description" content="Configuration the Gateway with an Identity Provider and Client Credential Grant">
    <meta property="og:image" content="https://bcgov.github.io/aps-infra-platform/guides/assets/oauth2.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://bcgov.github.io/aps-infra-platform/guides/tutorial-idp-client-cred-flow/">
    <meta property="twitter:title" content="Client Credential Protection">
    <meta property="twitter:description" content="Configuration the Gateway with an Identity Provider and Client Credential Grant">
    <meta property="twitter:image" content="https://bcgov.github.io/aps-infra-platform/guides/assets/oauth2.png">

    <script data-cfasync="false">(function () { var el = document.documentElement, m = localStorage.getItem("doc_theme"), wm = window.matchMedia; if (m === "dark" || (!m && wm && wm("(prefers-color-scheme: dark)").matches)) { el.classList.add("dark") } else { el.classList.remove("dark") } })();</script>

    <link href="../../resources/css/retype.css?v=3.5.0.750538702969" rel="stylesheet">

    <script data-cfasync="false" src="../../resources/js/config.js?v=3.5.0.750538702969" data-turbo-eval="false" defer></script>
    <script data-cfasync="false" src="../../resources/js/retype.js?v=3.5.0" data-turbo-eval="false" defer></script>
    <script id="lunr-js" data-cfasync="false" src="../../resources/js/lunr.js?v=3.5.0.750538702969" data-turbo-eval="false" defer></script>
    <script id="prism-js" data-cfasync="false" src="../../resources/js/prism.js?v=3.5.0.750538702969" defer></script>
</head>
<body>
    <div id="docs-app" class="relative text-base antialiased text-gray-700 bg-white font-body dark:bg-dark-850 dark:text-dark-300">
        <div class="absolute bottom-0 left-0 bg-gray-100 dark:bg-dark-800" style="top: 5rem; right: 50%"></div>
    
        <header id="docs-site-header" class="sticky top-0 z-30 flex w-full h-16 bg-white border-b border-gray-200 md:h-20 dark:bg-dark-850 dark:border-dark-650">
            <div class="container relative flex items-center justify-between pr-6 grow md:justify-start">
                <!-- Mobile menu button skeleton -->
                <button v-cloak class="skeleton docs-mobile-menu-button flex items-center justify-center shrink-0 overflow-hidden dark:text-white focus:outline-none rounded-full w-10 h-10 ml-3.5 md:hidden"><svg xmlns="http://www.w3.org/2000/svg" class="mb-px shrink-0" width="24" height="24" viewBox="0 0 24 24" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor"><path d="M2 4h20v2H2zM2 11h20v2H2zM2 18h20v2H2z"></path></g></svg></button>
                <div v-cloak id="docs-sidebar-toggle"></div>
        
                <!-- Logo -->
                <div class="flex items-center justify-between h-full py-2 md:w-75">
                    <div class="flex items-center px-2 md:px-6">
                        <a id="docs-site-logo" href="../../" class="flex items-center leading-snug text-xl">
                            <span class="dark:text-white font-semibold line-clamp-1 md:line-clamp-2">BC Gov API Services</span>
                        </a>
                    </div>
        
                    <span class="hidden h-8 border-r md:inline-block dark:border-dark-650"></span>
                </div>
        
                <div class="flex justify-between md:grow">
                    <!-- Top Nav -->
                    <nav class="hidden md:flex">
                        <ul class="flex flex-col mb-4 md:pl-16 md:mb-0 md:flex-row md:items-center">
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://api.gov.bc.ca">API Services Portal</a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://chat.developer.gov.bc.ca/channel/aps-ops">Rocket.Chat #aps-ops</a>
                            </li>
                            <li class="mr-6">
                                <a class="py-2 md:mb-0 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://uptime.com/s/bcgov-dss">Status</a>
                            </li>
        
                        </ul>
                    </nav>
        
                    <!-- Header Right Skeleton -->
                    <div v-cloak class="flex justify-end grow skeleton">
        
                        <!-- Search input mock -->
                        <div class="relative hidden w-40 lg:block lg:max-w-sm lg:ml-auto">
                            <div class="absolute flex items-center justify-center h-full pl-3 dark:text-dark-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon-base" width="16" height="16" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 1px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                            </div>
                            <input class="w-full h-10 placeholder-gray-400 transition-colors duration-200 ease-in bg-gray-200 border border-transparent rounded md:text-sm hover:bg-white hover:border-gray-300 focus:outline-none focus:bg-white focus:border-gray-500 dark:bg-dark-600 dark:border-dark-600 dark:placeholder-dark-400" style="padding: 0.625rem 0.75rem 0.625rem 2rem" type="text" placeholder="Search">
                        </div>
        
                        <!-- Mobile search button -->
                        <div class="flex items-center justify-center w-10 h-10 lg:hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="20" height="20" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><path d="M21.71 20.29l-3.68-3.68A8.963 8.963 0 0020 11c0-4.96-4.04-9-9-9s-9 4.04-9 9 4.04 9 9 9c2.12 0 4.07-.74 5.61-1.97l3.68 3.68c.2.19.45.29.71.29s.51-.1.71-.29c.39-.39.39-1.03 0-1.42zM4 11c0-3.86 3.14-7 7-7s7 3.14 7 7c0 1.92-.78 3.66-2.04 4.93-.01.01-.02.01-.02.01-.01.01-.01.01-.01.02A6.98 6.98 0 0111 18c-3.86 0-7-3.14-7-7z" ></path></g></svg>
                        </div>
        
                        <!-- Dark mode switch placeholder -->
                        <div class="w-10 h-10 lg:ml-2"></div>
        
                        <!-- History button -->
                        <div class="flex items-center justify-center w-10 h-10" style="margin-right: -0.625rem;">
                            <svg xmlns="http://www.w3.org/2000/svg" class="shrink-0 icon-base" width="22" height="22" viewBox="0 0 24 24" aria-labelledby="icon" role="presentation" style="margin-bottom: 0px;"><g fill="currentColor" ><g ><path d="M12.01 6.01c-.55 0-1 .45-1 1V12a1 1 0 00.4.8l3 2.22a.985.985 0 001.39-.2.996.996 0 00-.21-1.4l-2.6-1.92V7.01c.02-.55-.43-1-.98-1z"></path><path d="M12.01 1.91c-5.33 0-9.69 4.16-10.05 9.4l-.29-.26a.997.997 0 10-1.34 1.48l1.97 1.79c.19.17.43.26.67.26s.48-.09.67-.26l1.97-1.79a.997.997 0 10-1.34-1.48l-.31.28c.34-4.14 3.82-7.41 8.05-7.41 4.46 0 8.08 3.63 8.08 8.09s-3.63 8.08-8.08 8.08c-2.18 0-4.22-.85-5.75-2.4a.996.996 0 10-1.42 1.4 10.02 10.02 0 007.17 2.99c5.56 0 10.08-4.52 10.08-10.08.01-5.56-4.52-10.09-10.08-10.09z"></path></g></g></svg>
                        </div>
                    </div>
        
                    <div v-cloak class="flex justify-end grow">
                        <div id="docs-mobile-search-button"></div>
                        <doc-search-desktop></doc-search-desktop>
        
                        <doc-theme-switch class="lg:ml-2"></doc-theme-switch>
                        <doc-history></doc-history>
                    </div>
                </div>
            </div>
        </header>
    
        <div class="container relative flex bg-white">
            <!-- Sidebar Skeleton -->
            <div v-cloak class="fixed flex flex-col shrink-0 duration-300 ease-in-out bg-gray-100 border-gray-200 sidebar top-20 w-75 border-r h-screen md:sticky transition-transform skeleton dark:bg-dark-800 dark:border-dark-650">
            
                <!-- Render this div, if config.showSidebarFilter is `true` -->
                <div class="flex items-center h-16 px-6">
                    <input class="w-full h-8 px-3 py-2 transition-colors duration-200 ease-linear bg-white border border-gray-200 rounded shadow-none text-sm focus:outline-none focus:border-gray-600 dark:bg-dark-600 dark:border-dark-600" type="text" placeholder="Filter">
                </div>
            
                <div class="pl-6 mt-1 mb-4">
                    <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-32 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-48 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                    <div class="w-40 h-3 mb-4 bg-gray-200 rounded-full loading dark:bg-dark-600"></div>
                </div>
            
                <div class="shrink-0 mt-auto bg-transparent dark:border-dark-650">
                    <a class="flex items-center justify-center flex-nowrap h-16 text-gray-400 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                        <span class="text-xs whitespace-nowrap">Powered by</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                    </a>
                </div>
            </div>
            
            <!-- Sidebar component -->
            <doc-sidebar v-cloak>
                <template #sidebar-footer>
                    <div class="shrink-0 mt-auto border-t md:bg-transparent md:border-none dark:border-dark-650">
            
                        <div class="py-3 px-6 md:hidden border-b dark:border-dark-650">
                            <nav>
                                <ul class="flex flex-wrap justify-center items-center">
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://api.gov.bc.ca">API Services Portal</a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://chat.developer.gov.bc.ca/channel/aps-ops">Rocket.Chat #aps-ops</a>
                                    </li>
                                    <li class="mr-6">
                                        <a class="block py-1 inline-flex items-center text-sm whitespace-nowrap transition-colors duration-200 ease-linear md:text-blue-500 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-200" href="https://uptime.com/s/bcgov-dss">Status</a>
                                    </li>
            
                                </ul>
                            </nav>
                        </div>
            
                        <a class="flex items-center justify-center flex-nowrap h-16 text-gray-400 dark:text-dark-400 hover:text-gray-700 dark:hover:text-dark-300 transition-colors duration-150 ease-in docs-powered-by" target="_blank" href="https://retype.com/" rel="noopener">
                            <span class="text-xs whitespace-nowrap">Powered by</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-2" fill="currentColor" width="96" height="20" overflow="visible"><path d="M0 0v20h13.59V0H0zm11.15 17.54H2.44V2.46h8.71v15.08zM15.8 20h2.44V4.67L15.8 2.22zM20.45 6.89V20h2.44V9.34z"/><g><path d="M40.16 8.44c0 1.49-.59 2.45-1.75 2.88l2.34 3.32h-2.53l-2.04-2.96h-1.43v2.96h-2.06V5.36h3.5c1.43 0 2.46.24 3.07.73s.9 1.27.9 2.35zm-2.48 1.1c.26-.23.38-.59.38-1.09 0-.5-.13-.84-.4-1.03s-.73-.28-1.39-.28h-1.54v2.75h1.5c.72 0 1.2-.12 1.45-.35zM51.56 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92h4.74v1.83h-6.79V5.36h6.64zM60.09 7.15v7.48h-2.06V7.15h-2.61V5.36h7.28v1.79h-2.61zM70.81 14.64h-2.06v-3.66l-3.19-5.61h2.23l1.99 3.45 1.99-3.45H74l-3.19 5.61v3.66zM83.99 6.19c.65.55.97 1.4.97 2.55s-.33 1.98-1 2.51-1.68.8-3.04.8h-1.23v2.59h-2.06V5.36h3.26c1.42 0 2.45.28 3.1.83zm-1.51 3.65c.25-.28.37-.69.37-1.22s-.16-.92-.48-1.14c-.32-.23-.82-.34-1.5-.34H79.7v3.12h1.38c.68 0 1.15-.14 1.4-.42zM95.85 5.36V7.2h-4.59v1.91h4.13v1.76h-4.13v1.92H96v1.83h-6.79V5.36h6.64z"/></g></svg>
                        </a>
                    </div>
                </template>
            </doc-sidebar>
    
            <div class="grow min-w-0 dark:bg-dark-850">
                <!-- Render "toolbar" template here on api pages --><!-- Render page content -->
                <div class="flex">
                    <div class="min-w-0 p-4 grow md:px-16">
                        <main class="relative pb-12 lg:pt-2">
                            <div class="docs-markdown" id="docs-content">
                                <!-- Rendered if sidebar right is enabled -->
                                <div id="docs-sidebar-right-toggle"></div>
                                <!-- Page content  -->
<doc-anchor-target id="protecting-an-api-with-oauth2-client-credential-flow" class="break-words">
    <h1>
        <doc-anchor-trigger class="header-anchor-trigger" to="#protecting-an-api-with-oauth2-client-credential-flow">#</doc-anchor-trigger>
        <span>Protecting an API with OAuth2 Client Credential Flow</span>
    </h1>
</doc-anchor-target>
<p>Steps for protecting and calling an API using the OAuth2 Client Credential Grant.</p>
<ol>
<li>Configuring an API on the Kong Gateway</li>
<li>Granting Access to the IdP</li>
<li>Client Requesting Access</li>
<li>Provider Approving Access</li>
<li>Client Retrieving the Access Token</li>
<li>Client Calling an API</li>
<li>Gateway Proxying to Upstream</li>
</ol>
<p><figure class="content-center">
    <img src="../assets/oauth2.png" alt="alt text" title="Protecting an API">
    <figcaption class="caption">alt text</figcaption>
</figure>
</p>
<doc-anchor-target id="1-configuring-an-api-on-the-kong-gateway">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#1-configuring-an-api-on-the-kong-gateway">#</doc-anchor-trigger>
        <span>1. Configuring an API on the Kong Gateway</span>
    </h2>
</doc-anchor-target>
<p>The API Provider User Journey document provides the steps to enable a new API on the Kong Gateway. It will walk you through the creation of a new Namespace, and a Service Account that can be used to configure the Kong Gateway and the Authorization Profile described in step 2.</p>
<p>Once the API is working on the Gateway, you can then define a Product, which can be made available on the API Services Portal Directory.</p>
<doc-anchor-target id="2-granting-access-to-the-idp">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#2-granting-access-to-the-idp">#</doc-anchor-trigger>
        <span>2. Granting Access to the IdP</span>
    </h2>
</doc-anchor-target>
<doc-anchor-target id="custom-idp">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#custom-idp">#</doc-anchor-trigger>
        <span>Custom IdP</span>
    </h3>
</doc-anchor-target>
<doc-anchor-target id="a-prerequisites">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#a-prerequisites">#</doc-anchor-trigger>
        <span>a) Prerequisites</span>
    </h4>
</doc-anchor-target>
<p>Before the Portal can be configured, a new set of credentials must be created on the IdP. For this tutorial, we will include the steps when Keycloak is the IdP.</p>
<p><strong>Create a new Client on the IdP</strong></p>
<p>Create a new client with Access Type <code v-pre>confidential</code>. All flows except <code v-pre>Service Accounts</code> should be turned off.</p>
<p>Make a note of the <code v-pre>Client ID</code> and <code v-pre>Client Secret</code> , they will be used when the Portal <code v-pre>Authorization Profile</code> is created.</p>
<p>The <code v-pre>Full Scope Allowed</code> can be turned off and the <code v-pre>realm-management</code> client roles for <code v-pre>manage-clients</code> and <code v-pre>manage-users</code> should be added.</p>
<p>Add the <code v-pre>manage-clients</code> and <code v-pre>manage-users</code> client roles to the <code v-pre>Service Account Roles</code>.</p>
<doc-anchor-target id="b-setup-the-authorization-profile">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#b-setup-the-authorization-profile">#</doc-anchor-trigger>
        <span>b) Setup the Authorization Profile</span>
    </h4>
</doc-anchor-target>
<p>A credential with <code v-pre>CredentialIssuer.Admin</code> is required to update Authorization Profiles (<code v-pre>CredentialIssuer</code>).</p>
<p>Authorization Profiles can be setup either via the Portal or by using a Service Account with the Portal Directory API.</p>
<p>Update the below <code v-pre>CredentialIssuer</code> to include the environment details and the Scopes and Roles setup for authorization.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-yaml"><code v-pre class="language-yaml">kind: CredentialIssuer
name: Resource Server Example
namespace: $NS
description: Authorization Profile for protecting Ministry of XYZ
flow: client-credentials
mode: auto
authPlugin: jwt-keycloak
clientAuthenticator: client-secret
clientRoles: []
clientMappers:
  - name: audience
    defaultValue: &quot;&quot;
availableScopes: [Function1/read, Function2/*, Function3/write, Function3/read]
owner: &lt;your-username&gt;
environmentDetails:
  - environment: prod
    issuerUrl: https://auth-issuer
    clientId: testapp-client
    clientRegistration: managed
    clientSecret: &quot;&quot;</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="c-link-the-authorization-profile-to-the-product">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#c-link-the-authorization-profile-to-the-product">#</doc-anchor-trigger>
        <span>c) Link the Authorization Profile to the Product</span>
    </h4>
</doc-anchor-target>
<p>Before making the API available on the Directory, the API should be configured with a plugin for protecting access. To do this, an API Provider can edit the Product details to select <code v-pre>Oauth2 Client Credential Flow</code> and the newly created Authorization Profile.</p>
<doc-anchor-target id="d-update-your-gateway-configuration-with-the-plugin">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#d-update-your-gateway-configuration-with-the-plugin">#</doc-anchor-trigger>
        <span>d) Update your Gateway Configuration with the Plugin</span>
    </h4>
</doc-anchor-target>
<p>Update your Gateway Configuration to include the <code v-pre>jwt-keycloak</code> plugin.</p>
<blockquote>
<p>HINT: When you configure the Product Environment, a <code v-pre>Plugin Template</code> will be displayed - this can be a starting point for protecting your API on the Gateway.</p>
</blockquote>
<p>Finally, from the Portal, <code v-pre>enable</code> the Environment to make it available on the API Directory.</p>
<doc-anchor-target id="e-optional-configuration">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#e-optional-configuration">#</doc-anchor-trigger>
        <span>e) Optional Configuration</span>
    </h4>
</doc-anchor-target>
<p><strong>Scopes</strong></p>
<p>If you have Client Scopes that you want to have controlled by the Portal, add them to the Realm&#x27;s <code v-pre>Client Scopes</code> and <code v-pre>Default Client Scopes</code> on the IdP.</p>
<p>Update the <code v-pre>CredentialIssuer</code> record above to match the <code v-pre>availableScopes</code> with the ones added on the IdP.</p>
<p><strong>Roles</strong></p>
<p>If you have Roles that you want to have controlled by the Portal, add them to the Client&#x27;s <code v-pre>Roles</code>.</p>
<p>Update the <code v-pre>CredentialIssuer</code> record above to match the <code v-pre>clientRoles</code> with the ones added on the IdP.</p>
<p><strong>Client Mappers</strong></p>
<p>The <code v-pre>audience</code> is an optional mapper that can be added to a Client.</p>
<p>The IdP needs to have a policy that allows Audience to be added as a Protocol Mapper to the client.</p>
<p>In Keycloak, this is updated under the Realm&#x27;s <code v-pre>Client Registration</code> -&gt; <code v-pre>Client Registration Policies</code>.</p>
<p>Edit the Authenticated Access Policies -&gt; Allowed Protocol Mapper Types to include the <code v-pre>oidc-audience-mapper</code>.</p>
<p><strong>UMA2 Authorization Resources</strong></p>
<p>If you want to use the Authorization services, then set <code v-pre>Authorization Enabled</code> to <code v-pre>ON</code> for the Client on the IdP. You will also want to set the <code v-pre>Decision Strategy</code> to <code v-pre>Affirmative</code>.</p>
<p>Update the following <code v-pre>CredentialIssuer</code> attributes:</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">  resourceType: &quot;&quot;
  resourceAccessScope: &quot;&quot;
  resourceScopes: []</code></pre>
</doc-codeblock></div>
<ul>
<li><code v-pre>resourceType</code>: The Resource Type of the resources that will be managed (required)</li>
<li><code v-pre>resourceScopes</code>: A list of the Authorization Scopes managed for the particular Resources (required)</li>
<li><code v-pre>resourceAccessScope</code>: Used in the case where the Resource Server owns all the resources, a user must have the <code v-pre>resourceAccessScope</code> assigned in order to be allowed to manage the access. If it is not set, then the user has to be the resource owner in order to manage access.</li>
</ul>
<blockquote>
<p><code v-pre>resourceAccessScope</code> - The API Services Portal has not completed the implementation for the scenario where the User is the Resource Owner (<code v-pre>resourceAccessScope</code> is left blank). It uses the <code v-pre>Token Exchange</code> capability but it&#x27;s an optional service available on Keycloak and has numerous caveats around it. Please contact the APS team if interested to know more.</p>
</blockquote>
<doc-anchor-target id="shared-idp">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#shared-idp">#</doc-anchor-trigger>
        <span>Shared IdP</span>
    </h3>
</doc-anchor-target>
<p>Shared IdP is a new feature that allows you, as an API Provider, to leverage the SSO Gold-tier Keycloak cluster for managing Client Credentials, without having to deal with it directly.
The APS team have a custom realm on this Keycloak called <code v-pre>apigw</code> which the API Services Portal administers.</p>
<p>Token Issuers:</p>
<ul>
<li><a href="https://dev.loginproxy.gov.bc.ca/auth/realms/apigw">https://dev.loginproxy.gov.bc.ca/auth/realms/apigw</a></li>
<li><a href="https://test.loginproxy.gov.bc.ca/auth/realms/apigw">https://test.loginproxy.gov.bc.ca/auth/realms/apigw</a></li>
<li><a href="https://loginproxy.gov.bc.ca/auth/realms/apigw">https://loginproxy.gov.bc.ca/auth/realms/apigw</a></li>
</ul>
<p>To use it, perform the following steps:</p>
<doc-anchor-target id="a-setup-the-authorization-profile">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#a-setup-the-authorization-profile">#</doc-anchor-trigger>
        <span>a) Setup the Authorization Profile</span>
    </h4>
</doc-anchor-target>
<p>A credential with <code v-pre>CredentialIssuer.Admin</code> is required to update Authorization Profiles (<code v-pre>CredentialIssuer</code>).</p>
<p>Authorization Profiles can be setup either via the Portal or by using a Service Account with the Portal Directory API.</p>
<p>Update the below <code v-pre>CredentialIssuer</code> with the <code v-pre>name</code> and <code v-pre>description</code> that makes sense to you, and include the desired Roles setup for authorization.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-yaml"><code v-pre class="language-yaml">kind: CredentialIssuer
name: Resource Server Example
namespace: $NS
description: Authorization Profile for protecting Ministry of XYZ
flow: client-credentials
mode: auto
authPlugin: jwt-keycloak
clientAuthenticator: client-secret
clientRoles: []
inheritFrom: Gold Shared IdP</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="b-link-the-authorization-profile-to-the-product">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#b-link-the-authorization-profile-to-the-product">#</doc-anchor-trigger>
        <span>b) Link the Authorization Profile to the Product</span>
    </h4>
</doc-anchor-target>
<p>Before making the API available on the Directory, the API should be configured with a plugin for protecting access. To do this, an API Provider can edit the Product details to select <code v-pre>Oauth2 Client Credential Flow</code> and the newly created Authorization Profile.</p>
<doc-anchor-target id="c-update-your-gateway-configuration-with-the-plugin">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#c-update-your-gateway-configuration-with-the-plugin">#</doc-anchor-trigger>
        <span>c) Update your Gateway Configuration with the Plugin</span>
    </h4>
</doc-anchor-target>
<p>Update your Gateway Configuration to include the <code v-pre>jwt-keycloak</code> plugin.</p>
<blockquote>
<p>HINT: When you configure the Product Environment, a <code v-pre>Plugin Template</code> will be displayed - this can be a starting point for protecting your API on the Gateway.</p>
</blockquote>
<p>Finally, from the Portal, <code v-pre>enable</code> the Environment to make it available on the API Directory.</p>
<doc-anchor-target id="d-optional-configuration">
    <h4>
        <doc-anchor-trigger class="header-anchor-trigger" to="#d-optional-configuration">#</doc-anchor-trigger>
        <span>d) Optional Configuration</span>
    </h4>
</doc-anchor-target>
<p><strong>Roles</strong></p>
<p>If you have Roles that you want to have controlled by the Portal, add them to the Client&#x27;s <code v-pre>Roles</code>.</p>
<p>Update the <code v-pre>CredentialIssuer</code> record above with the <code v-pre>clientRoles</code> you want to manage.</p>
<doc-anchor-target id="3-client-requesting-access">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#3-client-requesting-access">#</doc-anchor-trigger>
        <span>3. Client Requesting Access</span>
    </h2>
</doc-anchor-target>
<p>Request access to the API via the API Services Portal and generate the credentials to be used below.</p>
<p>The Portal will use the credentials setup in the Authorization Profile, to create a disabled Client on the IdP (with any applicable Client Mappers) and return the credentials to the Requesting user.</p>
<doc-anchor-target id="4-provider-approving-access">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#4-provider-approving-access">#</doc-anchor-trigger>
        <span>4. Provider Approving Access</span>
    </h2>
</doc-anchor-target>
<p>An Access Manager reviews the access request, sets any additional controls, grants the relevant permissions (i.e./ scopes and roles), and approves. The Portal will enable the Client and apply the permissions on the IdP.</p>
<p>The Portal sends a notification to the Requester letting them know that API Access has been approved (or rejected).</p>
<doc-anchor-target id="5-client-retrieving-the-access-token">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#5-client-retrieving-the-access-token">#</doc-anchor-trigger>
        <span>5. Client Retrieving the Access Token</span>
    </h2>
</doc-anchor-target>
<p>Using the Credentials generated in step 3, the Requester calls the Token endpoint to get a new JWT token.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">export CID=&quot;&quot;
export CSC=&quot;&quot;
export URL=&quot;&quot;

curl $URL \
  -X POST -H &quot;Content-Type: application/x-www-form-urlencoded&quot; \
  -d client_id=$CID -d client_secret=$CSC \
  -d grant_type=client_credentials \
  -d scopes=openid</code></pre>
</doc-codeblock></div>
<doc-anchor-target id="6-client-calling-the-api">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#6-client-calling-the-api">#</doc-anchor-trigger>
        <span>6. Client Calling the API</span>
    </h2>
</doc-anchor-target>
<p>Extract the Access Token from the response, set it in a <code v-pre>TOK</code> environment variable, and call the API.</p>
<div class="codeblock-wrapper"><doc-codeblock>
<pre class="language-none"><code v-pre class="language-none">curl -v -H &quot;Authorization: Bearer $TOK&quot; \
  https://myservice.api.gov.bc.ca/v1/status</code></pre>
</doc-codeblock></div>
<p>The API Gateway&#x27;s <code v-pre>jwt-keycloak</code> plugin will use the IdP&#x27;s public keys to validate the token and depending on the plugin configuration, validate the scopes or roles.</p>
<doc-anchor-target id="7-gateway-proxying-to-upstream">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#7-gateway-proxying-to-upstream">#</doc-anchor-trigger>
        <span>7. Gateway Proxying to Upstream</span>
    </h2>
</doc-anchor-target>
<p>A technical, but important step in the integration is the Gateway proxying the request to the Upstream Service API and deciding on the different options for securing that interaction.</p>
<p>Options:</p>
<ul>
<li><p><code v-pre>Network Policy</code> : If the Services are co-located on the same Cluster as the Gateway&#x27;s Data Plane, then native network policies can be used to protect the channel between the Gateway and the Upstream Service. This approach is used for Services running on the Openshift Silver cluster.</p>
</li>
<li><p><code v-pre>Kong Upstream JWT</code>: This plugin adds a signed JWT to the request headers so that the Upstream Service can verify that the request came specifically from the Gateway.</p>
</li>
<li><p><code v-pre>Client Certificates</code> : Client certificates (mTLS) provides a way for the Upstream Service to provide a secure channel from the Gateway and to verify that the request came specifically from the Gateway.</p>
</li>
<li><p><code v-pre>Firewall IP Restrictions</code> : This provides a low-level of protection by limiting the IPs to the ones of the Gateway Data Planes. Because the Data Planes are typically on shared infrastructure, this would still allow traffic from other tenants. This might be acceptable based on the type of data delivered by or to the Upstream Service.</p>
</li>
</ul>
<doc-anchor-target id="variations">
    <h2>
        <doc-anchor-trigger class="header-anchor-trigger" to="#variations">#</doc-anchor-trigger>
        <span>Variations</span>
    </h2>
</doc-anchor-target>
<doc-anchor-target id="signed-jwt">
    <h3>
        <doc-anchor-trigger class="header-anchor-trigger" to="#signed-jwt">#</doc-anchor-trigger>
        <span>Signed JWT</span>
    </h3>
</doc-anchor-target>
<p>The Authorization Profile <code v-pre>clientAuthenticator</code> was set to <code v-pre>client-secret</code> in this tutorial, but there is an alternate setup that can be used:</p>
<ul>
<li><code v-pre>client-jwt-jwks-url</code> (Signed JWT with JWKS URL or Certificate)</li>
</ul>
<p>In this scenario, when a Client is requesting access, they will be required to enter details about the client assertion certificates. The details can either be a public JWKS URL that holds the public key information for a key pair, or providing just the public key information. The information will be used in step 5 when retrieving the Bearer Token. For further details, you can see the specific examples <a href="../intro-signed-jwt/">Signed JWT w/ Hosted JWKS</a> or <a href="../intro-signed-jwt-pubkey/">Signed JWT w/ Certificate</a>.</p>

                                <div class="flex items-center mt-6 mb-6 clear-both">
                                    <span>
                                        <a href="../../tags/">
                                            <svg class="inline-block -mb-px mr-1.5 text-blue-500 dark:text-blue-400" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" overflow="visible" fill="currentColor"><g><path d="M21.3 9.88l-8.59-8.59C12.52 1.11 12.27 1 12 1H2c-.55 0-1 .45-1 1v10c0 .27.11.52.29.71l8.59 8.58c.57.57 1.32.88 2.12.88s1.55-.31 2.12-.88l7.17-7.17a3.009 3.009 0 00.01-4.24zm-1.42 2.82l-7.17 7.17c-.39.39-1.02.39-1.42 0L3 11.59V3h8.59l8.29 8.29c.39.39.39 1.03 0 1.41z" /><path d="M7.01 6C6.45 6 6 6.45 6 7s.45 1 1 1 1-.45 1-1-.44-1-.99-1z" /></g></svg>
                                        </a>
                                        <span class="mr-2"><a href="../../tags/ns.platform/" class="no-link inline-flex align-middle items-center justify-center font-medium leading-none whitespace-nowrap text-blue-500 dark:text-blue-400 border border-blue-500 dark:border-blue-400 hover:bg-blue-100 dark:hover:bg-transparent dark:hover:border-blue-200 dark:hover:text-blue-200 transition-colors duration-200 ease-out h-6 px-2 text-xs rounded-md">
                                    <span>ns.platform</span>
                                </a></span>
                                        <span class="mr-2"><a href="../../tags/tutorial/" class="no-link inline-flex align-middle items-center justify-center font-medium leading-none whitespace-nowrap text-blue-500 dark:text-blue-400 border border-blue-500 dark:border-blue-400 hover:bg-blue-100 dark:hover:bg-transparent dark:hover:border-blue-200 dark:hover:text-blue-200 transition-colors duration-200 ease-out h-6 px-2 text-xs rounded-md">
                                    <span>tutorial</span>
                                </a></span>
                                    </span>
                                </div>
                
                                <!-- Required only on API pages -->
                                <doc-toolbar-member-filter-no-results></doc-toolbar-member-filter-no-results>
                            </div>
                            <footer class="clear-both">
                            
                                <nav class="flex mt-14">
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 h-full flex items-center break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-l-lg transition-colors duration-150 relative hover:z-5" href="../../guides/owner-journey-v1/">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="mr-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19 11H7.41l5.29-5.29a.996.996 0 10-1.41-1.41l-7 7a1 1 0 000 1.42l7 7a1.024 1.024 0 001.42-.01.996.996 0 000-1.41L7.41 13H19c.55 0 1-.45 1-1s-.45-1-1-1z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                            <span>
                                                <span class="block text-xs font-normal text-gray-400 dark:text-dark-400">Previous</span>
                                                <span class="block mt-1">API Provider User Journey V​1</span>
                                            </span>
                                        </a>
                                    </div>
                            
                                    <div class="w-1/2">
                                        <a class="px-5 py-4 -mx-px h-full flex items-center justify-end break-normal font-medium text-blue-500 dark:text-blue-400 border border-gray-300 hover:border-gray-400 dark:border-dark-650 dark:hover:border-dark-450 rounded-r-lg transition-colors duration-150 relative hover:z-5" href="../../guides/intro-signed-jwt-pubkey/">
                                            <span>
                                                <span class="block text-xs font-normal text-right text-gray-400 dark:text-dark-400">Next</span>
                                                <span class="block mt-1">Signed JWT w/ Certificate</span>
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" class="ml-3" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" overflow="visible"><path d="M19.92 12.38a1 1 0 00-.22-1.09l-7-7a.996.996 0 10-1.41 1.41l5.3 5.3H5c-.55 0-1 .45-1 1s.45 1 1 1h11.59l-5.29 5.29a.996.996 0 000 1.41c.19.2.44.3.7.3s.51-.1.71-.29l7-7c.09-.09.16-.21.21-.33z" /><path fill="none" d="M0 0h24v24H0z" /></svg>
                                        </a>
                                    </div>
                                </nav>
                            </footer>
                        </main>
                
                        <div class="border-t dark:border-dark-650 pt-6 mb-8">
                            <footer class="flex flex-wrap items-center justify-between">
                                <div>
                                    <ul class="flex flex-wrap items-center text-sm">
                                    </ul>
                                </div>
                                <div class="docs-copyright py-2 text-gray-500 dark:text-dark-350 text-sm leading-relaxed"><p>© Copyright 2023. All rights reserved.</p></div>
                            </footer>
                        </div>
                    </div>
                
                    <!-- Rendered if sidebar right is enabled -->
                    <!-- Sidebar right skeleton-->
                    <div v-cloak class="fixed top-0 bottom-0 right-0 translate-x-full bg-white border-gray-200 lg:sticky lg:border-l lg:shrink-0 lg:pt-6 lg:transform-none sm:w-1/2 lg:w-64 lg:z-0 md:w-104 sidebar-right skeleton dark:bg-dark-850 dark:border-dark-650">
                        <div class="pl-5">
                            <div class="w-32 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                            <div class="w-48 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                            <div class="w-40 h-3 mb-4 bg-gray-200 dark:bg-dark-600 rounded-full loading"></div>
                        </div>
                    </div>
                
                    <!-- User should be able to hide sidebar right -->
                    <doc-sidebar-right v-cloak></doc-sidebar-right>
                </div>

            </div>
        </div>
    
        <doc-search-mobile></doc-search-mobile>
        <doc-back-to-top></doc-back-to-top>
    </div>


    <div id="docs-overlay-target"></div>

    <script data-cfasync="false">window.__DOCS__ = { "title": "Client Credential Protection", level: 2, icon: "file", hasPrism: true, hasMermaid: false, hasMath: false, tocDepth: 23 }</script>
</body>
</html>
